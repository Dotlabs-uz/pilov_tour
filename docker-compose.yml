services:
  traefik:
    image: traefik:2.11
    container_name: appwrite-traefik
    <<: *x-logging
    command:
      - --providers.docker=true
      - --entrypoints.web.address=:80
      - --entrypoints.web.http.redirections.entryPoint.to=websecure
      - --entrypoints.web.http.redirections.entryPoint.scheme=https
      - --entrypoints.web.http.redirections.entryPoint.permanent=true
      - --entrypoints.websecure.address=:443
      - --certificatesresolvers.resolver.acme.tlschallenge=true
      - --certificatesresolvers.resolver.acme.email=dsarifkulo021@gmail.com
      - --certificatesresolvers.resolver.acme.storage=/letsencrypt/acme.json
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /var/run/docker.sock:/var/run/docker.sock
      - ../volumes/letsencrypt:/letsencrypt
    networks:
      - dropin

  app:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        NODE_ENV: production
        NEXT_PUBLIC_APPWRITE_PROJECT_ID: $NEXT_PUBLIC_APPWRITE_PROJECT_ID
        NEXT_PUBLIC_APPWRITE_PROJECT_NAME: $NEXT_PUBLIC_APPWRITE_PROJECT_NAME
        NEXT_PUBLIC_APPWRITE_ENDPOIN: $NEXT_PUBLIC_APPWRITE_ENDPOINT
        NEXT_PUBLIC_APPWRITE_DATABASE_ID: $NEXT_PUBLIC_APPWRITE_DATABASE_ID
        NEXT_PUBLIC_APPWRITE_API_KEY: $NEXT_PUBLIC_APPWRITE_API_KEY
        NEXT_PUBLIC_APPWRITE_TOURS_COLLECTION_ID: $NEXT_PUBLIC_APPWRITE_TOURS_COLLECTION_ID
        NEXT_PUBLIC_APPWRITE_USERS_COLLECTION_ID: $NEXT_PUBLIC_APPWRITE_USERS_COLLECTION_ID
        NEXT_PUBLIC_APPWRITE_BUCKET_ID: $NEXT_PUBLIC_APPWRITE_BUCKET_ID
    container_name: app
    restart: unless-stopped
    networks:
      - dropin
    labels:
      - traefik.enable=true
      - traefik.http.routers.app.rule=Host(`${HOST}`) && PathPrefix(`/`)
      - traefik.http.services.app.loadbalancer.server.port=3000
      - traefik.http.routers.app.entrypoints=websecure
      - traefik.http.routers.app.tls.certresolver=resolver
    environment:
      NEXT_PUBLIC_APPWRITE_PROJECT_ID: $NEXT_PUBLIC_APPWRITE_PROJECT_ID
      NEXT_PUBLIC_APPWRITE_PROJECT_NAME: $NEXT_PUBLIC_APPWRITE_PROJECT_NAME
      NEXT_PUBLIC_APPWRITE_ENDPOIN: $NEXT_PUBLIC_APPWRITE_ENDPOINT
      NEXT_PUBLIC_APPWRITE_DATABASE_ID: $NEXT_PUBLIC_APPWRITE_DATABASE_ID
      NEXT_PUBLIC_APPWRITE_API_KEY: $NEXT_PUBLIC_APPWRITE_API_KEY
      NEXT_PUBLIC_APPWRITE_TOURS_COLLECTION_ID: $NEXT_PUBLIC_APPWRITE_TOURS_COLLECTION_ID
      NEXT_PUBLIC_APPWRITE_USERS_COLLECTION_ID: $NEXT_PUBLIC_APPWRITE_USERS_COLLECTION_ID
      NEXT_PUBLIC_APPWRITE_BUCKET_ID: $NEXT_PUBLIC_APPWRITE_BUCKET_IDÂ§
    depends_on:
      - traefik

networks:
  dropin:
    driver: bridge
    
