FROM node:21.6.2-alpine

COPY ./package*.json ./pre_build/
RUN npm install -f --prefix /pre_build

COPY . ./pre_build

ARG NODE_ENV
ARG NEXT_PUBLIC_APPWRITE_PROJECT_ID
ARG NEXT_PUBLIC_APPWRITE_PROJECT_NAME
ARG NEXT_PUBLIC_APPWRITE_ENDPOINT
ARG NEXT_PUBLIC_APPWRITE_DATABASE_ID
ARG NEXT_PUBLIC_APPWRITE_API_KEY
ARG NEXT_PUBLIC_APPWRITE_TOURS_COLLECTION_ID
ARG NEXT_PUBLIC_APPWRITE_USERS_COLLECTION_ID
ARG NEXT_PUBLIC_APPWRITE_BUCKET_ID

ENV NODE_ENV=${NODE_ENV}
ENV NEXT_PUBLIC_APPWRITE_PROJECT_ID=${NEXT_PUBLIC_APPWRITE_PROJECT_ID}
ENV NEXT_PUBLIC_APPWRITE_PROJECT_NAME=${NEXT_PUBLIC_APPWRITE_PROJECT_NAME}
ENV NEXT_PUBLIC_APPWRITE_ENDPOINT=${NEXT_PUBLIC_APPWRITE_ENDPOINT}
ENV NEXT_PUBLIC_APPWRITE_DATABASE_ID=${NEXT_PUBLIC_APPWRITE_DATABASE_ID}
ENV NEXT_PUBLIC_APPWRITE_API_KEY=${NEXT_PUBLIC_APPWRITE_API_KEY}
ENV NEXT_PUBLIC_APPWRITE_TOURS_COLLECTION_ID=${NEXT_PUBLIC_APPWRITE_TOURS_COLLECTION_ID}
ENV NEXT_PUBLIC_APPWRITE_USERS_COLLECTION_ID=${NEXT_PUBLIC_APPWRITE_USERS_COLLECTION_ID}
ENV NEXT_PUBLIC_APPWRITE_BUCKET_ID=${NEXT_PUBLIC_APPWRITE_BUCKET_ID}

RUN npm run build --prefix /pre_build

RUN mkdir -p /build/

RUN cp -R pre_build/.next /build/.next
RUN cp -R pre_build/node_modules /build/node_modules
RUN cp -R pre_build/package.json /build/package.json
RUN cp -R pre_build/public /build/public
RUN cp -R pre_build/next.config.ts /build/next.config.ts

RUN rm -r /pre_build

CMD npm run start --prefix ./build

EXPOSE 3000